# Миграция системы боссов

## Описание изменений

Система боссов была полностью переработана с глобальных боссов на инстансы:

### Было (старая система):

- Глобальные боссы, общие для всех игроков
- Статусы боссов: available, in_battle, dead
- Автоматическое возрождение боссов после смерти
- Все игроки атакуют одного босса одновременно

### Стало (новая система):

- **Шаблоны боссов** (BossTemplate) - базовая информация о боссах
- **Инстансы боссов** (BossInstance) - личные или групповые копии боссов
- Каждый игрок создает свой инстанс и может пригласить друзей
- Ограничение по времени на инстанс (по умолчанию 30 минут)
- Требования по уровню для доступа к боссам
- Детальная статистика по каждому боссу

## Основные изменения

### Backend

#### Новые модели:

1. **BossTemplate** (`server/src/models/BossTemplate.js`)
   - Шаблон босса с базовыми характеристиками
   - Требуемый уровень для доступа
   - Глобальная статистика (убийства, рекорды)

2. **BossInstance** (`server/src/models/BossInstance.js`)
   - Активный инстанс босса
   - Владелец и участники
   - Таймер истечения
   - Статус завершения

#### Обновленные модели:

1. **User** - добавлены поля:
   - `activeBossInstance` - ссылка на активный инстанс
   - `bossStats` - Map со статистикой по каждому боссу (убийства, попытки, лучшее время)

#### Новые API endpoints:

- `GET /api/boss/template` - список шаблонов боссов
- `GET /api/boss/template/:id` - информация о шаблоне
- `POST /api/boss/template` - создание шаблона (admin)
- `GET /api/boss/template/:id/stats` - статистика по шаблону
- `POST /api/boss/instance/create` - создание инстанса
- `GET /api/boss/instance/active` - активный инстанс игрока
- `GET /api/boss/instance/:id` - информация об инстансе
- `POST /api/boss/instance/:id/join` - присоединение к инстансу
- `DELETE /api/boss/instance/:id` - удаление инстанса

#### Socket.io обновления:

- Новое событие: `joinBossInstance` - присоединение к инстансу
- Обновленное: `dealDamage` - теперь работает с instanceId
- Новое: `bossInstanceUpdate` - обновления состояния инстанса
- Новое: `bossInstanceDefeated` - поражение босса в инстансе
- Автоматическая очистка истекших инстансов

### Frontend

#### Обновленные страницы:

1. **`/bosses`** - список шаблонов боссов
   - Отображение доступных/недоступных боссов
   - Показ активного инстанса
   - Создание нового инстанса
   - Статистика по каждому боссу

2. **`/bosses/[id]`** - страница инстанса босса
   - Таймер обратного отсчета
   - HP бар босса
   - Участники боя
   - Лог боя с деталями урона
   - Реал-тайм обновления через Socket.io

## Шаги миграции

### 1. Остановите сервер

```bash
# Остановите запущенный сервер (Ctrl+C)
```

### 2. Убедитесь, что все изменения применены

```bash
cd server
git status  # Проверьте, что все файлы обновлены
```

### 3. Запустите скрипт миграции

```bash
cd server
node src/scripts/migrateBossSystem.js
```

Скрипт выполнит:

- ✅ Создание шаблонов из существующих боссов
- ✅ Преобразование статистики пользователей
- ✅ Удаление старых данных
- ✅ Отчет о выполненных действиях

### 4. Проверьте результат миграции

Скрипт выведет детальный отчет:

- Количество созданных шаблонов
- Количество обновленных пользователей
- Список созданных боссов с параметрами

### 5. Запустите сервер

```bash
npm run dev
```

### 6. Проверьте работу системы

1. Откройте браузер: http://localhost:3000/bosses
2. Должен отображаться список шаблонов боссов
3. Создайте инстанс босса (клик по боссу)
4. Попробуйте атаковать босса
5. Проверьте таймер истечения инстанса

## Откат (если нужно)

Если что-то пошло не так:

1. Остановите сервер
2. Восстановите базу данных из бэкапа (если делали)
3. Откатите изменения кода:

```bash
git checkout HEAD~1 -- server/src/
```

## Проверка после миграции

### Тестовые сценарии:

1. **Создание инстанса**
   - ✓ Можно создать инстанс доступного босса
   - ✓ Нельзя создать второй инстанс если есть активный
   - ✓ Нельзя создать инстанс недоступного босса (низкий уровень)

2. **Бой с боссом**
   - ✓ Урон наносится и отображается
   - ✓ HP босса уменьшается
   - ✓ Статистика участников обновляется
   - ✓ Лог боя работает

3. **Завершение боя**
   - ✓ Награды распределяются
   - ✓ Статистика обновляется
   - ✓ Можно создать новый инстанс

4. **Истечение времени**
   - ✓ Таймер отображается корректно
   - ✓ Инстанс становится недоступным после истечения
   - ✓ Можно создать новый инстанс

5. **Групповая игра**
   - ✓ Можно пригласить игрока в инстанс
   - ✓ Несколько игроков видят обновления
   - ✓ Награды делятся по урону

## Новые возможности

1. **Персональные инстансы** - каждый игрок может сражаться в своем темпе
2. **Ограничение по времени** - добавляет динамику и напряжение
3. **Требования по уровню** - прогрессия контента
4. **Групповая игра** - возможность объединяться с друзьями
5. **Детальная статистика** - рекорды, лучшее время, количество убийств
6. **Лог боя** - подробная информация о каждом ударе

## Устраненные баги

1. ✅ Исправлен баг с `senderId: null` в системных сообщениях
2. ✅ Убраны дублирующие индексы в моделях
3. ✅ Улучшена обработка ошибок Socket.io

## Производительность

- Индексы оптимизированы для быстрого поиска
- Автоматическая очистка истекших инстансов
- Кэширование данных на клиенте
- Эффективные Socket.io комнаты

## Поддержка

Если возникли проблемы:

1. Проверьте логи сервера
2. Проверьте консоль браузера
3. Убедитесь, что MongoDB работает
4. Проверьте версии зависимостей

## Статус миграции

- [x] Модели созданы
- [x] API endpoints реализованы
- [x] Socket.io обновлен
- [x] Frontend переработан
- [x] Скрипт миграции создан
- [x] Баги исправлены
- [ ] Миграция выполнена
- [ ] Тестирование пройдено
